<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        :root{--bg:#0f1419;--card:#1a1f2e;--accent:#7c3aed;--text:#e2e8f0;--muted:#94a3b8;--border:#334155;}
        body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:20px;}
        .container{max-width:1300px;margin:auto;}
        h1{text-align:center;margin:30px 0;background:linear-gradient(135deg,var(--accent),#a78bfa);-webkit-background-clip:text;color:transparent;font-size:3rem;}
        .tabs{display:flex;gap:10px;margin-bottom:30px;justify-content:center;flex-wrap:wrap;}
        .tab{background:var(--card);padding:12px 25px;border-radius:50px;cursor:pointer;border:1px solid var(--border);}
        .tab.active{background:var(--accent);color:white;}
        .section{display:none;padding:30px;background:var(--card);border-radius:16px;border:1px solid var(--border);}
        .section.active{display:block;}
        .dropzone{border:3px dashed var(--accent);padding:60px;text-align:center;border-radius:16px;margin:20px 0;cursor:pointer;transition:.3s;}
        .dropzone.dragover{background:var(--accent);color:white;}
        .file-list{margin:20px 0;max-height:300px;overflow:auto;background:#111;padding:15px;border-radius:8px;}
        .file-item{padding:8px;margin:4px 0;background:#222;border-radius:6px;display:flex;justify-content:space-between;}
        button{background:var(--accent);color:white;padding:12px 30px;border:none;border-radius:8px;cursor:pointer;font-size:1.1rem;margin:10px;}
        button:hover{background:#a78bfa;}
        .book-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-top:30px;}
        .book-item{background:var(--bg);padding:15px;border-radius:12px;border:1px solid var(--border);position:relative;}
        .book-cover img{width:100%;height:180px;object-fit:cover;border-radius:8px;}
        .book-cover .placeholder{background:linear-gradient(135deg,var(--accent),#4c1d95);height:180px;display:flex;align-items:center;justify-content:center;color:white;font-size:3rem;border-radius:8px;}
        .actions{position:absolute;top:10px;right:10px;gap:8px;display:flex;}
        .actions button{font-size:0.9rem;padding:6px 10px;}
    </style>
</head>
<body>
<div class="container">
    <h1>Academic Library Admin</h1>
    <div style="text-align:center;margin:20px;">
        <a href="/admin/logout" style="color:var(--muted);text-decoration:underline;">Logout</a>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="openTab('upload')">Upload Books</div>
        <div class="tab" onclick="openTab('manage')">Manage Books</div>
        <div class="tab" onclick="openTab('stats')">Stats & Settings</div>
    </div>

    <!-- UPLOAD TAB -->
    <div id="upload" class="section active">
        <h2>Drag & drop PDFs/EPUBs + optional cover JPGs</h2>
        <div class="dropzone" id="dropzone">
            Drop files here or click to select<br><br>
            <input type="file" multiple style="display:none" id="fileInput">
            <small>PDF, EPUB, MOBI + JPG/PNG covers</small>
        </div>
        <div class="file-list" id="fileList"></div>
        <div style="text-align:center;">
            <button id="uploadBtn" onclick="uploadBooks()">Upload All Books</button>
        </div>
    </div>

    <!-- MANAGE TAB -->
    <div id="manage" class="section">
        <h2>All Books ({{ books|length }})</h2>
        <div class="book-grid">
            {% for book in books %}
            <div class="book-item">
                <div class="book-cover">
                    {% if book.cover_image %}
                        <img src="{{ url_for('get_cover', book_id=book.id) }}">
                    {% else %}
                        <div class="placeholder">{{ book.title[:2]|upper }}</div>
                    {% endif %}
                </div>
                <strong>{{ book.title }}</strong><br>
                <small>{{ book.author or 'Unknown' }} • {{ book.category }} • {{ book.language }}</small>
                <div class="actions">
                    <button onclick="editBook({{ book.id }})">Edit</button>
                    <button onclick="deleteBook({{ book.id }})" style="background:#ef4444;">Delete</button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- STATS TAB -->
    <div id="stats" class="section">
        <h2>Donation Links</h2>
        <div id="donationList"></div>
        <input type="text" id="newName" placeholder="Name (e.g. Buy Me a Coffee)" style="width:48%;padding:10px;">
        <input type="url" id="newUrl" placeholder="URL" style="width:48%;padding:10px;">
        <button onclick="addDonation()">Add Link</button>
    </div>
</div>

<script>
let selectedFiles = [];

const dropzone = document.getElementById('dropzone');
dropzone.onclick = () => document.getElementById('fileInput').click();
dropzone.ondragover = e => { e.preventDefault(); dropzone.classList.add('dragover'); };
dropzone.ondragleave = () => dropzone.classList.remove('dragover');
dropzone.ondrop = e => { e.preventDefault(); dropzone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); };
document.getElementById('fileInput').onchange = e => handleFiles(e.target.files);

function handleFiles(files) {
    selectedFiles = Array.from(files);
    const list = document.getElementById('fileList');
    list.innerHTML = selectedFiles.map(f => `<div class="file-item">${f.name} (${(f.size/1024/1024).toFixed(1)} MB)</div>`).join('');
}

async function uploadBooks() {
    const btn = document.getElementById('uploadBtn');
    btn.disabled = true;
    btn.textContent = 'Uploading...';

    const form = new FormData();

    // Separate books and covers
    const bookFiles = [];
    const coverFiles = [];

    selectedFiles.forEach(f => {
        if (f.name.match(/\.(pdf|epub|mobi)$/i)) {
            bookFiles.push(f);
        } else if (f.name.match(/\.(jpe?g|png|webp)$/i)) {
            coverFiles.push(f);
        }
    });

    // VERY IMPORTANT — these two lines send the files correctly
    bookFiles.forEach(book => form.append('books', book));
    coverFiles.forEach(cover => form.append('covers', cover));   // ← THIS LINE IS REQUIRED

    try {
        const res = await fetch('/admin/upload', {
            method: 'POST',
            body: form
        });
        const data = await res.json();
        const successCount = data.filter(x => x.success).length;
        alert(`Uploaded ${successCount} book(s) successfully!`);
        location.reload();
    } catch (e) {
        alert('Upload error: ' + e);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Upload All Books';
    }
}

function editBook(id) {
    const title = prompt('Title:');
    const author = prompt('Author:', '');
    const desc = prompt('Description:', '');
    const cat = prompt('Category:', '');
    const lang = prompt('Language:', '');
    if (!title) return;

    fetch(`/admin/book/${id}`, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({title, author, description:desc, category:cat, language:lang})
    }).then(r=>r.json()).then(d=>{
        if(d.success) { alert('Saved!'); location.reload(); }
    });
}

function deleteBook(id) {
    if(confirm('Delete this book forever?')) {
        fetch(`/admin/book/${id}`, {method:'DELETE'})
        .then(r=>r.json())
        .then(d=>{ if(d.success) location.reload(); });
    }
}

function openTab(name) {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.querySelector(`[onclick="openTab('${name}')"]`).classList.add('active');
    document.getElementById(name).classList.add('active');
}

// Donation links
fetch('/admin').then(r=>r.text()).then(html=>{
    const links = {{ donation_links|tojson }};
    document.getElementById('donationList').innerHTML = links.map(l=>`
        <div style="margin:10px 0;padding:10px;background:#111;border-radius:8px;">
            ${l.name} — <a href="${l.url}" target="_blank">${l.url}</a>
            <button onclick="removeDonation('${l.name}')" style="float:right;background:#ef4444;">Remove</button>
        </div>`).join('') || '<i>No donation links yet</i>';
});
function addDonation() {
    const name = document.getElementById('newName').value.trim();
    const url = document.getElementById('newUrl').value.trim();
    if(!name||!url) return;
    const links = {{ donation_links|tojson }};
    links.push({name,url});
    fetch('/admin/settings', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({donation_links:links})})
    .then(()=>location.reload());
}
function removeDonation(name) {
    let links = {{ donation_links|tojson }};
    links = links.filter(l=>l.name!==name);
    fetch('/admin/settings', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({donation_links:links})})
    .then(()=>location.reload());
}
</script>
</body>
</html>
